from gamegym.algorithms import BestResponse, OutcomeMCCFR, exploitability
from gamegym.games import Goofspiel
from gamegym.games.goofspiel import goofspiel_feaures_cards
from gamegym.value_learning.valuesgd import SparseSGDLinearValueLearning
from gamegym.value_learning.valuestore import LinearValueStore
from gamegym.algorithms.infosets import InformationSetSampler
import numpy as np
import matplotlib.pyplot as plt
import itertools

import logging
logging.basicConfig(level=logging.INFO)

def main():
    N = 4
    ITERS = 2000000
    g = Goofspiel(N, scoring=Goofspiel.Scoring.ZEROSUM)
    mc = OutcomeMCCFR(g, seed=56)
    fname = "goof-{}".format(N)

    its = 1024
    while its < ITERS:
        cached = mc.persist(fname, iterations=its)
        if not cached: 
            print("Exploitability after {:7d} turns (mc, g): {}, {}".format(
                its, exploitability(g, 0, mc), exploitability(g, 1, mc)))
        its *= 2
    infosampler = InformationSetSampler(g, mc)

    vsts = (1, 3)
    gsts = (1, 3)
    ax0 = plt.subplot(len(vsts), len(gsts), 1)
    for i, (vst, gst) in enumerate(itertools.product(vsts, gsts)):
        vs = LinearValueStore(goofspiel_feaures_cards(g.initial_state()), fix_mean=(N + 1) / 2.0)
        vl = SparseSGDLinearValueLearning(g, goofspiel_feaures_cards, vs, infosampler, seed=44)
        vals = np.concatenate([
            vl.compute([mc, mc], 1000, step=s, record_every=1,
                val_samples=vst, grad_samples=gst)
                for s in [2**-8, 2**-9, 2**-10, 2**-11]
        ], axis=0)
        #c = ['red', 'green', 'blue', 'black'][i]
        ax = plt.subplot(len(vsts), len(gsts), i + 1, sharex=ax0, sharey=ax0)
        ax.plot(vals)
        ax.legend(list(range(1, N + 1)))
        ax.set_title("valseps={} gradsteps={}".format(vst, gst))
        print("Done sampling valseps={} gradsteps={}".format(vst, gst))
        print("Values:", vs.values)
    plt.show()

    return 

    g2 = Goofspiel(N, scoring=Goofspiel.Scoring.ZEROSUM, rewards=vs.values)
    mc2 = OutcomeMCCFR(g2, seed=57)
    mc2.compute(iterations=ITERS)
    print("Exp(mc2, g2)", exploitability(g2, 0, mc2), exploitability(g2, 1, mc2))
    print("Exp(mc2, g)", exploitability(g, 0, mc2), exploitability(g, 1, mc2))


if __name__ == '__main__':
    main()
